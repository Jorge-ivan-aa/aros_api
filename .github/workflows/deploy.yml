name: Deploy to Google Cloud
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Google Cloud Auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Start VM if it is stopped
        run: |
          STATUS=$(gcloud compute instances describe ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} --format='get(status)')
          if [ "$STATUS" = "TERMINATED" ]; then
            echo "VM is stopped. Starting it now..."
            gcloud compute instances start ${{ secrets.GGCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }}
            echo "Waiting 30 seconds for the VM to boot..."
            sleep 30
          else
            echo "VM is already running (Status: $STATUS)."
          fi

      - name: Create .env file for deployment
        run: |
          echo "Creating .env file with production values..."
          cat > .env << EOF
          DB_NAME=${{vars.DB_NAME}}
          DB_ROOT_PASSWORD=${{secrets.DB_ROOT_PASSWORD}}
          DB_PORT=${{vars.DB_PORT}}
          DB_HOST=db_deploy
          ADMIN_DOCUMENT=${{vars.ADMIN_DOCUMENT}}
          ADMIN_PASSWORD_HASH=${{secrets.ADMIN_PASSWORD_HASH}}
          TOKEN_SECRET=${{secrets.TOKEN_SECRET}}
          LOGGING_LEVEL_APP=${{vars.LOGGING_LEVEL_APP}}
          ALLOWED_ORIGINS=${{vars.ALLOWED_ORIGINS}}
          EOF

      - name: Copy configuration to VM
        run: |
          echo "Copying compose.yml and .env to the VM's home directory..."
          gcloud compute scp build/compose.yml .env ${{ secrets.GCP_VM_NAME }}:~/ --zone=${{ secrets.GCP_ZONE }}

      - name: Deploy on VM
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} --command='
            # Rename copied compose file to the default name
            mv ~/compose.yml ~/docker-compose.yml

            # Stop current services
            docker compose down

            # Pull the latest versions of all images defined in the compose file
            docker compose pull

            # Start new services in detached mode
            docker compose up -d

            # Aggressively prune all unused images to save disk space
            echo "Cleaning up all unused Docker images..."
            docker image prune -a -f

            # Verify services are running
            echo "Deployment completed. Checking running containers:"
            docker ps
          '
